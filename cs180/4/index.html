<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project 4</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script type="text/javascript" id="MathJax-script" async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>
</head>
<body>
    <div class="container">
        <!-- Introduction Paragraph -->
        <div class="section">
            <h2>CS 180 Project 4: (Auto)stitching and Photo Mosaics</h2>
            <p>In this project, I stitched together and rectified some images.</p>
        </div>


        <div class="section">
            <h2>Part 0: Shoot & Digitize Images </h2>

            I collected a ton of images of the past week for this project, here are the ones I ended up using.

            In order to make images work well with the mosaic, I made sure to keep the center of projection as constant as possible. I also tried to find interesting geometries that would make finding corresponding points simple. 

            <table>
                <tr>
                    <td><img src="media/bair_hall.jpg" alt="BAIR 1" width="95%"></td>
                    <td><img src="media/blackwell_straight_med.jpg" alt="Blackwell 1" width="95%"></td>
                    <td><img src="media/ihouse_chandelier.jpg" alt="IHouse 1" width="95%"></td>
                </tr>
                <tr>
                    <td><img src="media/bair_wall.jpg" alt="BAIR 2" width="95%"></td>
                    <td><img src="media/blackwell_study_med.jpg" alt="Blackwell 2" width="95%"></td>
                    <td><img src="media/ihouse_roof.jpg" alt="IHouse 2" width="95%"></td>
                </tr>
            </table>

            In order to make images work well with rectfication, I made sure to have images that have a distinct rectangular shape in them. 
            <table>
                <tr>
                    <td><img src="media/wave_puzzle_med.jpg" alt="Wave Puzzle" width="95%"></td>
                    <td><img src="media/bair_poster.jpg" alt="Bair Poster" width="95%"></td>
                </tr>
            </table>

        </div>

        <div class="section">
            <h2>Part 1: Recover Homographies </h2>

            In order to recover the homographies, I set up an equation to solve for the 8 unknown variables in our transformation matrix, H.
            
            Here's an example of how we want to be able to map points using H, and the matrix system we generate.

            <p> \[
                \begin{bmatrix}
                wx' \\
                wy' \\
                w
                \end{bmatrix}
                =
                H
                \begin{bmatrix}
                x \\
                y \\
                1
                \end{bmatrix}
                \]
            </p>
            
            <p> \[
                \begin{bmatrix}
                wx' \\
                wy' \\
                w
                \end{bmatrix}
                =
                \begin{bmatrix}
                a & b & c \\
                d & e & f \\
                g & h & 1
                \end{bmatrix}
                \begin{bmatrix}
                x \\
                y \\
                1
                \end{bmatrix}
                \]
            </p>

            <p> \[
                \begin{bmatrix}
                wx' \\
                wy' \\
                w
                \end{bmatrix}
                =
                \begin{bmatrix}
                ax + by + c \\
                dx + ey + f \\
                gx + hy + 1
                \end{bmatrix}
                \]
            </p>

            <p>
                \[
                \begin{cases}
                ax + by + c = (gx + hy + 1)x' \\
                dx + ey + f = (gx + hy + 1)y' 
                \end{cases}
                \]
            </p>

            <p></p>
                \[
                \begin{cases}
                ax + by + c -gxx' -hyx' = x' \\
                dx + ey + f -gxy' -hyy' = y' 
                \end{cases}
                \]
            </p>

            <p> \[
                \begin{bmatrix}
                x & y & 1 & 0 & 0 & 0 & -xx' & -yx'  \\
                0 & 0 & 0 & x & y & 1 & -xy' & -yy' 
                \end{bmatrix}
                \begin{bmatrix}
                a \\
                b \\
                c \\
                d \\
                e \\
                f \\
                g \\
                h 
                \end{bmatrix}
                =
                \begin{bmatrix}
                x' \\
                y' 
                \end{bmatrix}
                \]
            </p>


            <p> \[
                \begin{bmatrix}
                x_1 & y_1 & 1 & 0 & 0 & 0 & -x_1 x_1' & -y_1x_1'  \\
                0 & 0 & 0 & x_1 & y_1 & 1 & -x_1y_1' & -y_1y_1' \\
                x_2 & y_2 & 1 & 0 & 0 & 0 & -x_2 x_2' & -y_2x_2'  \\
                0 & 0 & 0 & x_2 & y_2 & 1 & -x_2y_2' & -y_2y_2' \\
                x_3 & y_3 & 1 & 0 & 0 & 0 & -x_3 x_3' & -y_3x_3'  \\
                0 & 0 & 0 & x_3 & y_3 & 1 & -x_3y_3' & -y_3y_3' \\
                x_4 & y_4 & 1 & 0 & 0 & 0 & -x_4 x_4' & -y_4x_4'  \\
                0 & 0 & 0 & x_4 & y_4 & 1 & -x_4y_4' & -y_4y_4' \\
                & & & & \vdots
                \end{bmatrix}
                \begin{bmatrix}
                a \\
                b \\
                c \\
                d \\
                e \\
                f \\
                g \\
                h 
                \end{bmatrix}
                =
                \begin{bmatrix}
                x_1' \\
                y_1' \\
                x_2' \\
                y_2' \\
                x_3' \\
                y_3' \\
                x_4' \\
                y_4' \\
                \vdots 
                \end{bmatrix}
                \]
            </p>
            
            Since this is now in the form Ax = b with x as the unknown, I was able to use np.linalg.lstsq in order to solve the system.
            This worked well because I tended to use more than the minimum 4 correspondances, so I had an overdetermined system.

        </div>

        <div class="section"></div>
            <h2>Part 2: Warp the Images</h2>

            Then, I implemented the warpImage function. First, I computed the output shape of the resulting image by figuring out what coordinates the orignal corners of the image mapped to by transforming the points with the transformation matrix H.

            Once this shape was established, I figured out how to offset the warped image to make it fit in the frame. 

            Then, I used inverse warping in conjuction with scipy.interpolate.griddata to fill in the image. I used nearest interpolation.

            Finally, I went back in and blacked out the pixels which were filled based on nearest pixel, but were actually not present in the orignal image. 

            All together, this is an example of a warped image of Blackwell residence hall. I did it in both directions. 
            <table>
                <tr>
                    <td><img src="media/blackwell_straight_med_tagged.jpg" alt="Blackwell Straight" width="95%"></td>
                    <td><img src="media/blackwell_warped.jpg" alt="Blackwell Study" width="95%"></td>
                </tr>
                <tr>
                    <td><img src="media/blackwell_warped_back.jpg" alt="Blackwell Straight" width="95%"></td>
                    <td><img src="media/blackwell_study_med_tagged.jpg" alt="Blackwell Study" width="95%"></td>
                </tr>
            </table>
        </div>

        <div class="section"></div>
            <h2>Part 4: Image Rectification</h2>


            For Part 3, Image Warping, 2 images with corresponding points were necessary.

            In this section, I rectified images based on known shapes.

            In order to do this, I marked the corners of a rectangular object in an image, and hardcoded the new actually rectangular points it should map to.

            I also decided to crop the image to just around the object of interest to speed up warping. 

            Then, I computed the H matrix going from the corners to the rectangular coordinates. Finally, I applied my warpImage function.

            Here are two examples I got, sorry for the poor resolution! 

            <table>
                <tr>
                    <td><img src="media/wave_puzzle_med.jpg" alt="Wave" width="95%"></td>
                    <td><img src="media/wave_flat.jpg" alt="Blackwell Study" width="95%"></td>
                </tr>
                <tr>
                    <td><img src="media/bair_poster.jpg" alt="Bair Poster" width="95%"></td>
                    <td><img src="media/bair_poster_flat.jpg" alt="Blackwell Study" width="95%"></td>
                </tr>
            </table>
        </div>

        <div class="section">
            <h2>Part 5: Mosaic</h2>
            
            Finally, I figured out how to combine together images into image mosaics. In order to do this, I took a one-shot approach. 

            First, I warped one of the images to match the shape of the other image. 
            
            Then, I computed the desired output shape by seeing how far off the reference points were from the sides in the warped image and the reference image.

            Next, I filled in the appropriate parts of the output image with both the warped image and the reference image, using weighted averaging to avoid strong edge artifacts. Here are my three example mosaics!

            <table>
                <tr>
                    <td><img src="media/blackwell_straight_med.jpg" alt="Wave" width="95%"></td>
                    <td><img src="media/blackwell_study_med.jpg" alt="Blackwell Study" width="95%"></td>
                    <td><img src="media/blackwell_mosaic.jpg" alt="Blackwell Study" width="95%"></td>
                </tr>
                <tr>
                    <td><img src="media/bair_hall.jpg" alt="Wave" width="95%"></td>
                    <td><img src="media/bair_wall.jpg" alt="Blackwell Study" width="95%"></td>
                    <td><img src="media/bair_hall_mosaic.jpg" alt="Blackwell Study" width="95%"></td>
                </tr>
                <tr></tr>
                    <td><img src="media/ihouse_chandelier.jpg" alt="Wave" width="95%"></td>
                    <td><img src="media/ihouse_roof.jpg" alt="Blackwell Study" width="95%"></td>
                    <td><img src="media/ihouse_mosaic.jpg" alt="Blackwell Study" width="95%"></td>
                </tr>
            </table>
            

        </div>



</body>
</html>